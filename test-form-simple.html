<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Simple Form Test</title>
   <style>
      body {
         font-family: Arial, sans-serif;
         margin: 20px;
      }

      .result {
         margin: 10px 0;
         padding: 10px;
         border-radius: 5px;
      }

      .success {
         background: #d4edda;
         color: #155724;
      }

      .error {
         background: #f8d7da;
         color: #721c24;
      }

      button {
         padding: 10px 15px;
         margin: 5px;
         background: #007bff;
         color: white;
         border: none;
         border-radius: 3px;
         cursor: pointer;
      }
   </style>
</head>

<body>
   <h1>üß™ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç API</h1>

   <button onclick="testAPI()">–¢–µ—Å—Ç API</button>
   <button onclick="clearCache()">–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>

   <div id="result"></div>

   <script>
      function showResult(message, isSuccess = true) {
         const element = document.getElementById('result');
         element.innerHTML = `<div class="result ${isSuccess ? 'success' : 'error'}">${message}</div>`;
      }

      async function testAPI() {
         try {
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
            console.log('–ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω...');
            const tokenResponse = await fetch('/api/auth/test-token');
            const tokenData = await tokenResponse.json();

            if (!tokenData.success) {
               throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ${tokenData.error}`);
            }

            const token = tokenData.data.token;
            console.log('–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω:', token.substring(0, 20) + '...');

            // –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É...');
            const formData = {
               profession: 'frontend-developer',
               country: 'RU',
               experience: '1-3',
               email: 'test@example.com',
               phone: '+7 (999) 123-45-67'
            };

            const formResponse = await fetch('/api/form', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
               },
               body: JSON.stringify(formData)
            });

            console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', formResponse.status);

            if (!formResponse.ok) {
               const errorText = await formResponse.text();
               throw new Error(`HTTP ${formResponse.status}: ${errorText}`);
            }

            const formResult = await formResponse.json();
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', formResult);

            showResult(`‚úÖ –£—Å–ø–µ—à–Ω–æ! –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: ${JSON.stringify(formResult.data)}`);

         } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showResult(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, false);
         }
      }

      function clearCache() {
         if ('caches' in window) {
            caches.keys().then(function (names) {
               for (let name of names) {
                  caches.delete(name);
               }
            });
         }

         if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
               for (let registration of registrations) {
                  registration.unregister();
               }
            });
         }

         localStorage.clear();
         showResult('‚úÖ –ö—ç—à –æ—á–∏—â–µ–Ω');
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      window.onload = function () {
         console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç...');
         testAPI();
      };
   </script>
</body>

</html>