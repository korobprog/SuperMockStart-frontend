# Исправление проблемы с токенами аутентификации

## Проблема

Пользователи получали ошибку `401 (Unauthorized)` при попытке получить доступ к календарным эндпоинтам (`/api/calendar/*`) и эндпоинтам обратной связи (`/api/feedback/*`). Ошибка возникала из-за неправильного сохранения и использования токенов аутентификации.

## Причина

1. **Неправильное сохранение токенов**: При авторизации через Telegram Web App бэкенд возвращал `extended_token`, но фронтенд сохранял его как `telegram_token`.

2. **Несоответствие типов токенов**: Календарные эндпоинты и эндпоинты обратной связи требуют `extended_token`, а эндпоинты формы используют обычный `telegram_token`.

3. **Неправильная навигация**: После оставления отзыва пользователь перенаправлялся на главную страницу вместо страницы интервью.

## Исправления

### 1. Исправление сохранения токенов в TelegramAuth

**Файл**: `src/components/TelegramAuth.tsx`

**Изменения**:

- Изменено сохранение токена с `telegram_token` на `extended_token`
- Обновлена проверка сохраненного токена для использования `extended_token`
- Изменен эндпоинт верификации на `/api/auth/verify-extended-token`

```typescript
// Было:
localStorage.setItem('telegram_token', authToken);

// Стало:
localStorage.setItem('extended_token', authToken);
```

### 2. Обновление функции getAuthToken

**Файлы**:

- `src/pages/Interview.tsx`
- `src/pages/Feedback.tsx`
- `src/pages/FeedbackHistory.tsx`

**Изменения**:

- Добавлена приоритетная проверка `extended_token`
- Сохранена обратная совместимость с `telegram_token`

```typescript
const getAuthToken = () => {
  // Сначала пробуем получить расширенный токен
  const extendedToken = localStorage.getItem('extended_token');
  if (extendedToken) {
    return extendedToken;
  }

  // Если расширенного токена нет, используем обычный (для обратной совместимости)
  return localStorage.getItem('telegram_token');
};
```

### 3. Исправление навигации после отзыва

**Файл**: `src/pages/Feedback.tsx`

**Изменения**:

- Изменена навигация с главной страницы на страницу интервью
- Пользователь теперь перенаправляется на `/interview` вместо `/`

```typescript
// Было:
window.location.href = '/';

// Стало:
window.location.href = '/interview';
```

## Тестирование

### Автоматические тесты

Создан тестовый скрипт `test-token-fix.js` для проверки работы календарных эндпоинтов и эндпоинтов обратной связи.

### Ручное тестирование

1. **Авторизация через Telegram**:

   - Откройте приложение в Telegram Web App
   - Авторизуйтесь через Telegram
   - Проверьте, что в localStorage сохранен `extended_token`

2. **Проверка календарных эндпоинтов**:

   - Перейдите на страницу интервью
   - Выберите профессию
   - Проверьте, что доступные слоты загружаются без ошибок

3. **Проверка обратной связи**:
   - Завершите интервью
   - Оставьте отзыв
   - Проверьте, что перенаправление происходит на страницу интервью

## Структура токенов

### Extended Token (для календарных эндпоинтов и обратной связи)

- **Генерируется**: При авторизации через Telegram Web App
- **Содержит**: `userDbId`, `authType`, `role`
- **Сохраняется**: В localStorage как `extended_token`
- **Используется**: Для `/api/calendar/*` и `/api/feedback/*`

### Regular Token (для эндпоинтов формы)

- **Генерируется**: При авторизации через Telegram Bot
- **Содержит**: `userId`, `username`, `firstName`, `lastName`
- **Сохраняется**: В localStorage как `telegram_token`
- **Используется**: Для `/api/form/*` и `/api/userStatus/*`

## Обратная совместимость

Все изменения сохраняют обратную совместимость:

- Пользователи с `telegram_token` могут продолжать использовать приложение
- Функция `getAuthToken()` автоматически выбирает правильный токен
- Старые токены продолжают работать для совместимых эндпоинтов

## Заключение

Исправления решают основную проблему с аутентификацией и обеспечивают правильную работу всех функций приложения. Пользователи теперь могут:

- Успешно получать доступ к календарным эндпоинтам
- Оставлять отзывы без ошибок аутентификации
- Правильно перенаправляться на страницу интервью после отзыва
- Создавать новые интервью после завершения предыдущих
