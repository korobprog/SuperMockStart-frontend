#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÑ€ÐµÐ´Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð±ÑÐºÐµÐ½Ð´ Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº ÑÑ€ÐµÐ´Ñ‹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
if [ ! -f "package.json" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸Ð· ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
    exit 1
fi

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð°
check_port() {
    local port=$1
    if netstat -ano | grep -q ":$port.*LISTENING"; then
        echo "âš ï¸  ÐŸÐ¾Ñ€Ñ‚ $port Ð·Ð°Ð½ÑÑ‚"
        return 1
    else
        echo "âœ… ÐŸÐ¾Ñ€Ñ‚ $port ÑÐ²Ð¾Ð±Ð¾Ð´ÐµÐ½"
        return 0
    fi
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ñ€Ñ‚Ñ‹
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²..."
check_port 3001 || {
    echo "âŒ ÐŸÐ¾Ñ€Ñ‚ 3001 Ð·Ð°Ð½ÑÑ‚. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ./scripts/dev-setup.sh Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸"
    exit 1
}

check_port 5432 || {
    echo "âš ï¸  ÐŸÐ¾Ñ€Ñ‚ 5432 Ð·Ð°Ð½ÑÑ‚ (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ PostgreSQL ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½)"
}

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env.local ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f ".env.local" ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env.local..."
    cat > .env.local << EOF
VITE_API_URL=http://localhost:3001
EOF
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ backend .env
if [ ! -f "backend/.env" ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ backend/.env..."
    cp backend/env.backend backend/.env
fi

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°..."
    npm install
fi

if [ ! -d "backend/node_modules" ]; then
    echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð±ÑÐºÐµÐ½Ð´Ð°..."
    cd backend && npm install && cd ..
fi

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Prisma ÐºÐ»Ð¸ÐµÐ½Ñ‚
echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Prisma ÐºÐ»Ð¸ÐµÐ½Ñ‚..."
cd backend && npx prisma generate && cd ..

echo ""
echo "âœ… Ð¡Ñ€ÐµÐ´Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð°!"
echo ""
echo "ðŸ“‹ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð² Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»Ð°Ñ…:"
echo ""
echo "Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 1 (Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…):"
echo "  cd backend && npm run db:studio"
echo ""
echo "Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 2 (Ð‘ÑÐºÐµÐ½Ð´):"
echo "  cd backend && npm run dev"
echo ""
echo "Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð» 3 (Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´):"
echo "  npm run dev"
echo ""
echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ URL:"
echo "- Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´: http://localhost:5173"
echo "- Ð‘ÑÐºÐµÐ½Ð´: http://localhost:3001"
echo "- Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…: localhost:5432"
echo ""
echo "ðŸ”§ Ð”Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð¾Ð² Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ: ./scripts/dev-setup.sh" 