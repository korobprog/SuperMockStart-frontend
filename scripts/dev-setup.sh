#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–æ—Ä—Ç—ã

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker stop $(docker ps -q) 2>/dev/null || true

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3001
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 3001..."
if netstat -ano | grep -q ":3001.*LISTENING"; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 3001 –∑–∞–Ω—è—Ç, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
    PID=$(netstat -ano | grep ":3001.*LISTENING" | awk '{print $5}' | head -1)
    if [ ! -z "$PID" ]; then
        echo "üîÑ –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $PID..."
        taskkill /PID $PID /F 2>/dev/null || true
        sleep 2
    fi
else
    echo "‚úÖ –ü–æ—Ä—Ç 3001 —Å–≤–æ–±–æ–¥–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 5432 (PostgreSQL)
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç 5432..."
if netstat -ano | grep -q ":5432.*LISTENING"; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 5432 –∑–∞–Ω—è—Ç, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
    PID=$(netstat -ano | grep ":5432.*LISTENING" | awk '{print $5}' | head -1)
    if [ ! -z "$PID" ]; then
        echo "üîÑ –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $PID..."
        taskkill /PID $PID /F 2>/dev/null || true
        sleep 2
    fi
else
    echo "‚úÖ –ü–æ—Ä—Ç 5432 —Å–≤–æ–±–æ–¥–µ–Ω"
fi

echo "‚úÖ –°—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≥–æ—Ç–æ–≤–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: cd backend && npm run db:studio"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥: cd backend && npm run dev"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: npm run dev"
echo ""
echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ URL:"
echo "- –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://localhost:5173"
echo "- –ë—ç–∫–µ–Ω–¥: http://localhost:3001"
echo "- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: localhost:5432" 