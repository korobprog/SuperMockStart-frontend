#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./migrate-database.sh

SERVER_IP="217.198.6.238"
PROJECT_PATH="/root/supermock"

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏..."

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üì• –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É..."
ssh -i ~/.ssh/timeweb_vps_key root@$SERVER_IP << EOF
    cd $PROJECT_PATH
    
    echo "üîÑ –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
    git pull origin master
    
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend..."
    cd backend
    npm install
    
    echo "üóÑÔ∏è –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç..."
    npx prisma generate
    
    echo "üö® –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    echo "‚ö†Ô∏è  –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–∏—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è email –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ç–∞–±–ª–∏—Ü—É user_form_data"
    npx prisma migrate deploy
    
    echo "üë§ –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)..."
    npm run create-admin
    
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend —Å–µ—Ä–≤–∏—Å..."
    cd ..
    pm2 restart supermock-backend
    
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
    pm2 status
    
    echo "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    cd backend
    npx prisma db pull --print
EOF

echo ""
echo "üéâ –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìä –ß—Ç–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:"
echo "   ‚úÖ UserRole enum (ADMIN, USER)"
echo "   ‚úÖ –ü–æ–ª—è email –∏ password –¥–ª—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
echo "   ‚úÖ –ü–æ–ª–µ role –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
echo "   ‚úÖ –ü–æ–ª—è isActive –∏ lastLoginAt –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
echo "   ‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_form_data –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º"
echo "   ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ email"
echo ""
echo "üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ API:"
echo "   Frontend: https://supermock.ru"
echo "   Backend Health: https://api.supermock.ru/api/health"
echo "   Auth endpoints: https://api.supermock.ru/api/auth"