# Система статусов пользователей

## Описание

Система позволяет пользователям переключаться между статусами "Интервьюер" и "Кандидат" в зависимости от их участия в интервью.

## Логика работы

1. **Регистрация**: Пользователь по умолчанию получает статус `INTERVIEWER`
2. **Проведение интервью**: Интервьюер создает интервью с кандидатом
3. **Завершение интервью**: Интервью помечается как завершенное
4. **Обратная связь**: После получения обратной связи статус интервьюера автоматически меняется на `CANDIDATE`
5. **Цикл**: Кандидат может стать интервьюером для других кандидатов

## Структура базы данных

### Таблица `users`

- `id` - уникальный идентификатор
- `telegramId` - ID пользователя в Telegram
- `username`, `firstName`, `lastName` - данные пользователя
- `status` - статус пользователя (`INTERVIEWER` или `CANDIDATE`)
- `createdAt`, `updatedAt` - временные метки

### Таблица `interviews`

- `id` - уникальный идентификатор интервью
- `interviewerId` - ID интервьюера
- `candidateId` - ID кандидата
- `status` - статус интервью (`PENDING`, `COMPLETED`, `FEEDBACK_RECEIVED`)
- `feedback` - обратная связь
- `feedbackReceivedAt` - время получения обратной связи
- `createdAt`, `updatedAt` - временные метки

## API Endpoints

### Аутентификация

- `GET /api/auth/test-token` - получить тестовый токен для разработки
- `POST /api/auth/telegram` - аутентификация через Telegram Web App
- `POST /api/auth/verify` - верификация JWT токена

### Управление статусами

- `GET /api/user-status/status` - получить текущий статус пользователя
- `PUT /api/user-status/status` - обновить статус пользователя (для тестирования)

### Управление интервью

- `POST /api/user-status/interviews` - создать интервью
- `PUT /api/user-status/interviews/:interviewId/complete` - завершить интервью
- `POST /api/user-status/interviews/:interviewId/feedback` - добавить обратную связь
- `GET /api/user-status/interviews` - получить интервью пользователя

### Получение данных

- `GET /api/user-status/candidates` - получить доступных кандидатов

## Фронтенд

### Тестовый интерфейс

На странице `/chooseinterview` создан временный интерфейс для тестирования:

- **Получение тестового токена** - кнопка для получения тестового токена
- **Отображение текущего статуса** - показывает текущий статус пользователя
- **Быстрое переключение статусов** - кнопки для изменения статуса
- **Список кандидатов** - показывает доступных кандидатов
- **История интервью** - показывает все интервью пользователя
- **Обновление данных** - кнопка для перезагрузки данных

### Использование

1. Откройте страницу `/chooseinterview`
2. Нажмите кнопку "Получить тестовый токен"
3. После получения токена используйте кнопки для переключения статусов
4. Используйте кнопку "Обновить данные" для синхронизации

## Установка и запуск

### 1. Применение миграции базы данных

```bash
cd backend
npx prisma migrate dev --name add-user-status-and-interviews
```

### 2. Запуск бэкенда

```bash
cd backend
npm run dev
```

### 3. Запуск фронтенда

```bash
npm run dev
```

## Тестирование

### Получение тестового токена

```bash
# Получить тестовый токен
curl -X GET http://localhost:3001/api/auth/test-token
```

### Ручное изменение статуса через API

```bash
# Изменить статус на кандидата
curl -X PUT http://localhost:3001/api/user-status/status \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId": "user_id", "status": "CANDIDATE"}'

# Изменить статус на интервьюера
curl -X PUT http://localhost:3001/api/user-status/status \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"userId": "user_id", "status": "INTERVIEWER"}'
```

### Через фронтенд

1. Откройте страницу `/chooseinterview`
2. Нажмите "Получить тестовый токен"
3. Используйте кнопки для переключения статусов
4. Проверьте обновление данных в реальном времени

## Тестовый токен

Для разработки и тестирования создан специальный тестовый токен:

- **Эндпоинт**: `GET /api/auth/test-token`
- **Данные пользователя**: Test User (@testuser)
- **Срок действия**: 30 дней
- **Автоматическое получение**: Фронтенд автоматически получает токен при необходимости

### Данные тестового пользователя

```json
{
  "id": 123456789,
  "first_name": "Test",
  "last_name": "User",
  "username": "testuser",
  "is_bot": false
}
```

## Важные моменты

- **Тестовый режим**: Интерфейс на фронтенде помечен как тестовый и должен быть удален в продакшене
- **Тестовый токен**: Создан специально для разработки, не использовать в продакшене
- **Аутентификация**: Все API endpoints требуют JWT токен
- **Автоматическое изменение статуса**: При получении обратной связи статус интервьюера автоматически меняется на кандидата
- **Безопасность**: В продакшене эндпоинт изменения статуса должен быть защищен административными правами

## Удаление тестового интерфейса

Перед деплоем в продакшен:

1. Удалите эндпоинт `GET /api/auth/test-token`
2. Удалите или защитите эндпоинт `PUT /api/user-status/status`
3. Удалите тестовый интерфейс со страницы `/chooseinterview`
4. Оставьте только функциональность для реального использования
